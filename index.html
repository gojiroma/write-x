<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>mogr</title>
    <style>
        body {
            font-family: 'Yu Mincho', 'Hiragino Mincho Pro', serif;
            background-color: #f5f5dc;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            min-height: 100vh;
            margin: 0;
        }

        .title-input {
            outline: none;
            text-align: center;
            width: 80%;
            max-width: 600px;
            padding: 12px;
            margin-bottom: 10px;
            font-size: 24px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: #fff8dc;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .content-textarea {
            outline: none;
            width: 80%;
            max-width: 600px;
            height: 30vh;
            padding: 15px;
            font-size: 16px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: #fff8dc;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            resize: none;
            margin-bottom: 20px;
            line-height: 25px;
        }

        ::selection {
            background-color: #ffff99;
        }

        .title-input,
        .content-textarea {
            caret-color: #ff6b6b;
            transition: caret-color 0.3s;
        }

        .content-textarea.list-navigation-mode {
            caret-color: blue;
        }

        .page-list-container {
            width: 80%;
            max-width: 600px;
            position: relative;
            margin-bottom: 20px;
            border: 1px solid transparent;
            padding: 5px;
        }

        .page-list {
            display: block;
            position: static;
            background-color: #fff8dc;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            z-index: 10;
            width: 100%;
        }

        .page-list button {
            text-align: center !important;
            display: block;
            width: 100%;
            text-align: left;
            padding: 8px;
            margin: 5px 0;
            background-color: #fff8dc;
            border: none;
            cursor: pointer;
        }

        .page-list button:hover,
        .page-list button.selected {
            background-color: #e8e8c8;
        }

        .highlight {
            background-color: #ffff99;
            font-weight: bold;
        }
    </style>
</head>

<body>
    <input type="text" id="title-input" class="title-input" placeholder="タイトルを入力..." autocomplete="off">
    <textarea id="content-textarea" class="content-textarea" placeholder="Wikiの内容を入力..."></textarea>
    <div class="page-list-container">
        <div class="page-list" id="page-list"></div>
    </div>

    <script>
        const LAST_OPENED_KEY = 'last_opened_page';
        let isIMEComposing = false;
        let isMouseOverList = false;
        let selectedIndex = -1;
        let pageButtons = [];
        let currentFilter = '';
        let listNavigationMode = false;
        let listNavigationTimeout = null;

        // 空のエントリを削除
        function cleanEmptyEntries() {
            for (let i = localStorage.length - 1; i >= 0; i--) {
                const key = localStorage.key(i);
                if (key.startsWith('wiki_')) {
                    const content = localStorage.getItem(key);
                    if (!content) {
                        localStorage.removeItem(key);
                        localStorage.removeItem(`wiki_meta_${key.replace('wiki_', '')}`);
                    }
                }
            }
        }

        // ページ一覧を表示（絞り込み対応、絞り込み時はアルファベット順、それ以外は更新日時順）
        function updatePageList(filter = '') {
            currentFilter = filter;
            const pageList = document.getElementById('page-list');
            if (isMouseOverList) return;

            pageList.innerHTML = '';
            const pages = [];
            pageButtons = [];

            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith('wiki_') && !key.startsWith('wiki_meta_')) {
                    const title = key.replace('wiki_', '');
                    const metaKey = `wiki_meta_${title}`;
                    const meta = JSON.parse(localStorage.getItem(metaKey) || '{"updatedAt": 0}');
                    pages.push({ title, updatedAt: meta.updatedAt });
                }
            }

            // 絞り込み時はアルファベット順、それ以外は更新日時順
            if (filter) {
                pages.sort((a, b) => a.title.localeCompare(b.title));
            } else {
                pages.sort((a, b) => b.updatedAt - a.updatedAt);
            }

            pages.forEach((page, index) => {
                if (filter && !page.title.includes(filter)) return;

                const button = document.createElement('button');
                if (filter) {
                    const regex = new RegExp(filter, 'gi');
                    button.innerHTML = page.title.replace(regex, match => `<span class="highlight">${match}</span>`);
                } else {
                    button.textContent = page.title;
                }
                button.onclick = () => loadPage(page.title);
                button.onmouseenter = () => loadPage(page.title);
                button.ondblclick = (e) => {
                    e.stopPropagation();
                    if (confirm(`${page.title}を削除しますか？`)) {
                        localStorage.removeItem(`wiki_${page.title}`);
                        localStorage.removeItem(`wiki_meta_${page.title}`);
                        if (document.getElementById('title-input').value === page.title) {
                            document.getElementById('title-input').value = '';
                            document.getElementById('content-textarea').value = '';
                        }
                        updatePageList(filter);
                    }
                };
                pageList.appendChild(button);
                pageButtons.push(button);
            });

            // 選択状態を更新
            if (selectedIndex >= 0 && selectedIndex < pageButtons.length) {
                pageButtons[selectedIndex].classList.add('selected');
            } else {
                selectedIndex = -1;
            }
        }

        // ページを保存
        function savePage() {
            const title = document.getElementById('title-input').value.trim();
            const content = document.getElementById('content-textarea').value;
            if (title && content.trim() !== '') {
                localStorage.setItem(`wiki_${title}`, content);
                const metaKey = `wiki_meta_${title}`;
                localStorage.setItem(metaKey, JSON.stringify({ updatedAt: Date.now() }));
                localStorage.setItem(LAST_OPENED_KEY, title);
                if (!isMouseOverList) updatePageList(currentFilter);
            }
        }

        // ページを読み込み
        function loadPage(title) {
            const content = localStorage.getItem(`wiki_${title}`);
            document.getElementById('title-input').value = title;
            document.getElementById('content-textarea').value = content || '';
            document.getElementById('content-textarea').focus();
            selectedIndex = -1;
            updatePageList(currentFilter);
        }

        // 新規作成
        function newPage() {
            document.getElementById('title-input').value = '';
            document.getElementById('content-textarea').value = '';
            document.getElementById('title-input').focus();
            selectedIndex = -1;
            updatePageList(currentFilter);
        }

        // textareaのカーソルが最終行末かどうかをチェック
        function isCursorAtEnd(textarea) {
            return textarea.selectionStart === textarea.value.length;
        }

        // inputの入力時にコンテンツの存在をチェック
        document.getElementById('title-input').addEventListener('input', function (e) {
            const title = e.target.value.trim();
            if (title) {
                const content = localStorage.getItem(`wiki_${title}`);
                if (content === null) {
                    document.getElementById('content-textarea').value = '';
                } else {
                    document.getElementById('content-textarea').value = content;
                }
            } else {
                document.getElementById('content-textarea').value = '';
            }
            savePage();
            updatePageList(currentFilter);
        });

        // 自動保存（内容が変更されたら保存）
        document.getElementById('content-textarea').addEventListener('input', savePage);

        // IME入力中のフラグ管理
        document.getElementById('title-input').addEventListener('compositionstart', () => {
            isIMEComposing = true;
        });

        document.getElementById('title-input').addEventListener('compositionend', () => {
            isIMEComposing = false;
        });

        // キーボードショートカット
        document.addEventListener('keydown', function (e) {
            const inputElement = document.getElementById('title-input');
            const textareaElement = document.getElementById('content-textarea');

            // textareaで下キーを押した時の処理
            if (document.activeElement === textareaElement && e.key === 'ArrowDown' && isCursorAtEnd(textareaElement)) {
                e.preventDefault();
                if (pageButtons.length === 0) return;

                // リストナビゲーションモード開始
                listNavigationMode = true;
                textareaElement.classList.add('list-navigation-mode');

                // 5秒後にモードを解除
                clearTimeout(listNavigationTimeout);
                listNavigationTimeout = setTimeout(() => {
                    listNavigationMode = false;
                    textareaElement.classList.remove('list-navigation-mode');
                }, 5000);

                // 選択解除
                if (selectedIndex !== -1) {
                    pageButtons[selectedIndex].classList.remove('selected');
                }

                selectedIndex = selectedIndex === -1 || selectedIndex >= pageButtons.length - 1 ? 0 : selectedIndex + 1;
                pageButtons[selectedIndex].classList.add('selected');
                pageButtons[selectedIndex].scrollIntoView({ block: 'nearest' });
            }
            // textareaで上キーを押した時の処理（リストナビゲーションモード時のみ）
            else if (document.activeElement === textareaElement && e.key === 'ArrowUp' && listNavigationMode) {
                e.preventDefault();
                if (pageButtons.length === 0) return;

                // 選択解除
                if (selectedIndex !== -1) {
                    pageButtons[selectedIndex].classList.remove('selected');
                }

                selectedIndex = selectedIndex <= 0 ? pageButtons.length - 1 : selectedIndex - 1;
                pageButtons[selectedIndex].classList.add('selected');
                pageButtons[selectedIndex].scrollIntoView({ block: 'nearest' });
            }
            // IME入力中でない場合のみEnterキーでtextareaにフォーカス（textareaを空欄にする）
            else if (document.activeElement === inputElement && e.key === 'Enter' && !isIMEComposing) {
                e.preventDefault();
                document.getElementById('content-textarea').value = '';
                document.getElementById('content-textarea').focus();
                updatePageList(currentFilter);
            }
            // 上下キーでページリストを移動
            else if (document.activeElement === inputElement && (e.key === 'ArrowUp' || e.key === 'ArrowDown')) {
                e.preventDefault();
                if (pageButtons.length === 0) return;

                // 選択解除
                if (selectedIndex !== -1) {
                    pageButtons[selectedIndex].classList.remove('selected');
                }

                if (e.key === 'ArrowUp') {
                    selectedIndex = selectedIndex <= 0 ? pageButtons.length - 1 : selectedIndex - 1;
                } else if (e.key === 'ArrowDown') {
                    selectedIndex = selectedIndex === -1 || selectedIndex >= pageButtons.length - 1 ? 0 : selectedIndex + 1;
                }

                // 選択適用
                if (selectedIndex !== -1) {
                    pageButtons[selectedIndex].classList.add('selected');
                    pageButtons[selectedIndex].scrollIntoView({ block: 'nearest' });
                    // 選択したページの内容を表示
                    const selectedTitle = pageButtons[selectedIndex].textContent;
                    const content = localStorage.getItem(`wiki_${selectedTitle}`);
                    document.getElementById('title-input').value = selectedTitle;
                    document.getElementById('content-textarea').value = content || '';
                }
            }
            // Tabキーでtextareaにフォーカス
            else if (document.activeElement === inputElement && e.key === 'Tab') {
                e.preventDefault();
                document.getElementById('content-textarea').focus();
            }
            // textareaでTabキーを押したらinputにフォーカス（空欄にする）
            else if (document.activeElement === textareaElement && e.key === 'Tab') {
                e.preventDefault();
                document.getElementById('title-input').value = '';
                document.getElementById('content-textarea').value = '';
                document.getElementById('title-input').focus();
            }
        });

        // inputの絞り込み機能
        document.getElementById('title-input').addEventListener('input', function (e) {
            if (!isMouseOverList) {
                updatePageList(e.target.value);
            }
        });

        // ページリストにマウスが乗った/離れた時の処理
        document.getElementById('page-list').addEventListener('mouseenter', () => {
            isMouseOverList = true;
        });
        document.getElementById('page-list').addEventListener('mouseleave', () => {
            isMouseOverList = false;
            updatePageList(document.getElementById('title-input').value);
        });

        // デバウンス関数
        function debounce(func, wait) {
            let timeout;
            return function () {
                const context = this, args = arguments;
                clearTimeout(timeout);
                timeout = setTimeout(() => {
                    func.apply(context, args);
                }, wait);
            };
        }

        // 選択文字列をタイトルとしてページを表示
        function handleTextSelection() {
            const textarea = document.getElementById('content-textarea');
            const selectedText = textarea.value.substring(textarea.selectionStart, textarea.selectionEnd).trim();
            if (selectedText) {
                const existingKey = `wiki_${selectedText}`;
                if (localStorage.getItem(existingKey) !== null) {
                    loadPage(selectedText);
                }
            }
        }

        // inputにフォーカスしたときは新規作成扱い（空欄にする）
        document.getElementById('title-input').addEventListener('focus', function () {
            const title = document.getElementById('title-input').value.trim();
            if (!title) {
                document.getElementById('content-textarea').value = '';
            }
            selectedIndex = -1;
            updatePageList(currentFilter);
        });

        // イベントリスナーを追加（デバウンス処理を適用）
        document.getElementById('content-textarea').addEventListener('mouseup', debounce(handleTextSelection, 200));

        // 初期表示
        window.addEventListener('load', function () {
            cleanEmptyEntries();
            const lastOpenedTitle = localStorage.getItem(LAST_OPENED_KEY);
            if (lastOpenedTitle) {
                loadPage(lastOpenedTitle);
            } else {
                document.getElementById('title-input').focus();
            }
            updatePageList();
        });
    </script>
</body>

</html>
