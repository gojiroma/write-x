<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ¹</text></svg>" />
    <title>mogr</title>
    <style>
        body {
            font-family: 'Yu Mincho', 'Hiragino Mincho Pro', serif;
            background-color: #f5f5dc;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            min-height: 100vh;
            margin: 0;
            position: relative;
            overflow-y: hidden;
        }

        .side-buttons {
            position: fixed;
            left: 10px;
            bottom: 1%;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 30;
            opacity: 0.2;
        }

        .side-button {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: none;
            background-color: #fff8dc;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 15px;
        }

        .side-button:hover {
            background-color: #e8e8c8;
        }

        .input-container {
            width: 80%;
            max-width: 600px;
            margin-bottom: 10px;
        }

        .title-input {
            outline: none;
            text-align: center;
            width: 100%;
            padding: 12px;
            font-size: 24px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: #fff8dc;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .content-textarea-wrapper {
            width: 80%;
            max-width: 600px;
            margin-bottom: 20px;
            position: relative;
        }

        .content-textarea {
            outline: none;
            width: 100%;
            height: 30vh;
            padding: 12px;
            font-size: 16px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: #fff8dc;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            resize: none;
            line-height: 25px;
        }

        .related-pages-container {
            position: absolute;
            right: -310px;
            top: 0;
            width: 300px;
            background-color: #fff8dc;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            z-index: 20;
            max-height: 300px;
            overflow-y: auto;
            overflow-x: hidden;
            display: none;
        }

        .related-pages-container.show {
            display: block;
        }

        .related-pages-list {
            list-style: none;
            padding: 0;
            margin: 0;
            white-space: nowrap;
        }

        .related-pages-list button,
        .related-pages-list a.related-url-button {
            display: block;
            width: 100%;
            text-align: left;
            padding: 8px;
            margin: 0;
            background-color: transparent;
            border: none;
            cursor: pointer;
            border-bottom: 1px solid #eee;
            text-align: left;
            text-decoration: none;
            color: #333;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .related-pages-list a.related-url-button {
            color: #0066cc;
        }

        .related-pages-list button:hover,
        .related-pages-list button.selected,
        .related-pages-list a.related-url-button:hover,
        .related-pages-list a.related-url-button.selected {
            background-color: #e8e8c8;
        }

        .related-pages-list button:focus,
        .related-pages-list a.related-url-button:focus {
            outline: 2px solid #ff6b6b;
        }

        ::selection {
            background-color: #ffff99;
        }

        .title-input,
        .content-textarea {
            caret-color: #ff6b6b;
            transition: caret-color 0.3s;
        }

        .content-textarea.list-navigation-mode {
            caret-color: blue;
        }

        .page-list-container {
            width: 87%;
            max-width: 623px;
            border: 1px solid transparent;
            padding: 5px 2px 10px 25px;
        }

        .page-list {
            display: block;
            position: static;
            background-color: #fff8dc;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            z-index: 10;
            width: 100%;
            max-height: 50vh;
            overflow-y: auto;
        }

        .page-list button {
            text-align: center !important;
            display: block;
            width: 100%;
            text-align: left;
            padding: 8px;
            margin: 5px 0;
            background-color: #fff8dc;
            border: none;
            cursor: pointer;
        }

        .page-list button:hover,
        .page-list button.selected {
            background-color: #e8e8c8;
        }

        .highlight {
            background-color: #ffff99;
            font-weight: bold;
        }

        #file-input {
            display: none;
        }
    </style>
</head>

<body>
    <div class="side-buttons">
        <button class="side-button" id="export-button" title="ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ (Ctrl+S)">å‡ºåŠ›</button>
        <button class="side-button" id="import-button" title="ã‚¤ãƒ³ãƒãƒ¼ãƒˆ (Ctrl+O)">å–è¾¼</button>
    </div>

    <div class="input-container">
        <input type="text" id="title-input" class="title-input" placeholder="ã‚¿ã‚¤ãƒˆãƒ«ã‚’å…¥åŠ›..." autocomplete="off">
    </div>
    <div class="content-textarea-wrapper">
        <textarea id="content-textarea" class="content-textarea" placeholder="Wikiã®å†…å®¹ã‚’å…¥åŠ›..."></textarea>
        <div class="related-pages-container" id="related-pages-container">
            <div class="related-pages-list" id="related-pages-list"></div>
        </div>
    </div>
    <div class="page-list-container">
        <div class="page-list" id="page-list"></div>
    </div>
    <input type="file" id="file-input" accept=".json">

    <script>
        const LAST_OPENED_KEY = 'last_opened_page';
        let isIMEComposing = false;
        let isMouseOverList = false;
        let selectedIndex = -1;
        let relatedSelectedIndex = -1;
        let pageButtons = [];
        let relatedPageButtons = [];
        let currentFilter = '';
        let listNavigationMode = false;
        let relatedListNavigationMode = false;
        let listNavigationTimeout = null;
        let relatedListNavigationTimeout = null;
        let audioContext = null;
        let lastHoveredTitle = null;
        let shiftKeyPressCount = 0;
        let shiftKeyPressTimeout = null;

        // ãƒ“ãƒ¼ãƒ—éŸ³ã‚’å†ç”Ÿã™ã‚‹é–¢æ•°
        function playBeep(frequency = 440, duration = 0.1) {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }

            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();

            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);

            oscillator.type = 'sine';
            oscillator.frequency.value = frequency;
            gainNode.gain.value = 0.1;
            gainNode.gain.exponentialRampToValueAtTime(0.0001, audioContext.currentTime + duration);

            oscillator.start();
            oscillator.stop(audioContext.currentTime + duration);
        }

        // ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚’è§£é™¤ã™ã‚‹é–¢æ•°
        function clearPageListHighlight() {
            pageButtons.forEach(button => {
                button.classList.remove('selected');
            });
            selectedIndex = -1;
        }

        // é–¢é€£ãƒšãƒ¼ã‚¸ãƒªã‚¹ãƒˆã®ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚’è§£é™¤ã™ã‚‹é–¢æ•°
        function clearRelatedPagesHighlight() {
            relatedPageButtons.forEach(button => {
                button.classList.remove('selected');
            });
            relatedSelectedIndex = -1;
        }

        // ç©ºã®ã‚¨ãƒ³ãƒˆãƒªã‚’å‰Šé™¤
        function cleanEmptyEntries() {
            for (let i = localStorage.length - 1; i >= 0; i--) {
                const key = localStorage.key(i);
                if (key.startsWith('wiki_')) {
                    const content = localStorage.getItem(key);
                    if (!content) {
                        localStorage.removeItem(key);
                        localStorage.removeItem(`wiki_meta_${key.replace('wiki_', '')}`);
                    }
                }
            }
        }

        // ãƒšãƒ¼ã‚¸ä¸€è¦§ã‚’è¡¨ç¤ºï¼ˆçµã‚Šè¾¼ã¿å¯¾å¿œã€çµã‚Šè¾¼ã¿æ™‚ã¯ã‚¢ãƒ«ãƒ•ã‚¡ãƒ™ãƒƒãƒˆé †ã€ãã‚Œä»¥å¤–ã¯æ›´æ–°æ—¥æ™‚é †ï¼‰
        function updatePageList(filter = '') {
            currentFilter = filter;
            const pageList = document.getElementById('page-list');
            pageList.innerHTML = '';
            const pages = [];
            pageButtons = [];

            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith('wiki_') && !key.startsWith('wiki_meta_')) {
                    const title = key.replace('wiki_', '');
                    const metaKey = `wiki_meta_${title}`;
                    const meta = JSON.parse(localStorage.getItem(metaKey) || '{"updatedAt": 0}');
                    pages.push({ title, updatedAt: meta.updatedAt });
                }
            }

            // çµã‚Šè¾¼ã¿æ™‚ã¯ã‚¢ãƒ«ãƒ•ã‚¡ãƒ™ãƒƒãƒˆé †ã€ãã‚Œä»¥å¤–ã¯æ›´æ–°æ—¥æ™‚é †
            if (filter) {
                pages.sort((a, b) => a.title.localeCompare(b.title));
            } else {
                pages.sort((a, b) => b.updatedAt - a.updatedAt);
            }

            pages.forEach((page, index) => {
                if (filter && !page.title.includes(filter)) return;

                const button = document.createElement('button');
                if (filter) {
                    const regex = new RegExp(filter, 'gi');
                    button.innerHTML = page.title.replace(regex, match => `<span class="highlight">${match}</span>`);
                } else {
                    button.textContent = page.title;
                }
                button.onclick = () => loadPage(page.title);
                button.onmouseenter = () => {
                    if (lastHoveredTitle !== page.title) {
                        playBeep();
                        lastHoveredTitle = page.title;
                        document.getElementById('title-input').value = page.title;
                        const content = localStorage.getItem(`wiki_${page.title}`);
                        document.getElementById('content-textarea').value = content || '';
                    }
                };
                button.ondblclick = (e) => {
                    e.stopPropagation();
                    if (confirm(`${page.title}ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
                        localStorage.removeItem(`wiki_${page.title}`);
                        localStorage.removeItem(`wiki_meta_${page.title}`);
                        if (document.getElementById('title-input').value === page.title) {
                            document.getElementById('title-input').value = '';
                            document.getElementById('content-textarea').value = '';
                        }
                        updatePageList(filter);
                    }
                };
                pageList.appendChild(button);
                pageButtons.push(button);
            });

            // é¸æŠçŠ¶æ…‹ã‚’æ›´æ–°
            if (selectedIndex >= 0 && selectedIndex < pageButtons.length) {
                pageButtons[selectedIndex].classList.add('selected');
            } else {
                selectedIndex = -1;
            }
        }

        // é–¢é€£ãƒšãƒ¼ã‚¸ãƒªã‚¹ãƒˆã‚’æ›´æ–°ï¼ˆåŒæ–¹å‘å¯¾å¿œï¼‰
        function updateRelatedPagesList() {
            const textarea = document.getElementById('content-textarea');
            const container = document.getElementById('related-pages-container');
            const list = document.getElementById('related-pages-list');
            const text = textarea.value;
            const currentTitle = document.getElementById('title-input').value.trim();

            // æ—¢å­˜ã®ãƒªã‚¹ãƒˆã‚’ã‚¯ãƒªã‚¢
            list.innerHTML = '';
            relatedPageButtons = [];

            // ãƒšãƒ¼ã‚¸ã‚¿ã‚¤ãƒˆãƒ«ã¨ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’å–å¾—
            const pages = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith('wiki_') && !key.startsWith('wiki_meta_')) {
                    const title = key.replace('wiki_', '');
                    const content = localStorage.getItem(key);
                    pages.push({ title, content });
                }
            }

            // åŒæ–¹å‘ã®é–¢é€£æ€§ã‚’ãƒã‚§ãƒƒã‚¯
            const foundTitles = [];
            pages.forEach(page => {
                if (page.title === currentTitle) return;

                // æœ¬æ–‡ã«ã‚¿ã‚¤ãƒˆãƒ«ãŒå«ã¾ã‚Œã‚‹ã‹
                const titleInContent = text.includes(page.title);
                // ã‚¿ã‚¤ãƒˆãƒ«ã«æœ¬æ–‡ãŒå«ã¾ã‚Œã‚‹ã‹
                const contentInTitle = page.content.includes(currentTitle);

                if (titleInContent || contentInTitle) {
                    foundTitles.push(page);
                }
            });

            // é–¢é€£ãƒšãƒ¼ã‚¸ãŒã‚ã‚Œã°ãƒªã‚¹ãƒˆã‚’è¡¨ç¤º
            if (foundTitles.length > 0) {
                foundTitles.forEach(page => {
                    const pageButton = document.createElement('button');
                    pageButton.textContent = page.title;
                    pageButton.onclick = () => {
                        clearPageListHighlight();
                        loadPage(page.title);
                        clearRelatedPagesHighlight();
                    };
                    list.appendChild(pageButton);
                    relatedPageButtons.push(pageButton);
                });
            }

            // ç¾åœ¨ã®textareaã®å†…å®¹ã‹ã‚‰URLã‚’æŠ½å‡ºãƒ»è¡¨ç¤º
            const urlRegex = /(https?:\/\/[^\s]+)/g;
            const urls = text.match(urlRegex);
            if (urls) {
                urls.forEach(url => {
                    const urlButton = document.createElement('a');
                    urlButton.href = url;
                    urlButton.textContent = url;
                    urlButton.target = '_blank';
                    urlButton.rel = 'noopener noreferrer';
                    urlButton.classList.add('related-url-button');
                    urlButton.onclick = (e) => {
                        e.preventDefault();
                        window.open(urlButton.href, '_blank');
                        document.getElementById('content-textarea').focus();
                    };
                    list.appendChild(urlButton);
                    relatedPageButtons.push(urlButton);
                });
            }

            if (foundTitles.length > 0 || urls) {
                container.classList.add('show');
            } else {
                container.classList.remove('show');
            }
        }

        // ãƒšãƒ¼ã‚¸ã‚’ä¿å­˜
        function savePage() {
            const title = document.getElementById('title-input').value.trim();
            const content = document.getElementById('content-textarea').value;
            if (title && content.trim() !== '') {
                localStorage.setItem(`wiki_${title}`, content);
                const metaKey = `wiki_meta_${title}`;
                localStorage.setItem(metaKey, JSON.stringify({ updatedAt: Date.now() }));
                localStorage.setItem(LAST_OPENED_KEY, title);
                updatePageList(currentFilter);
                updateRelatedPagesList();
            }
        }

        // ãƒšãƒ¼ã‚¸ã‚’èª­ã¿è¾¼ã¿
        function loadPage(title) {
            const content = localStorage.getItem(`wiki_${title}`);
            document.getElementById('title-input').value = title;
            document.getElementById('content-textarea').value = content || '';
            document.getElementById('content-textarea').focus();
            selectedIndex = -1;
            clearRelatedPagesHighlight();
            playBeep(880, 0.1); // ç¢ºå®šæ™‚ã®é«˜ã„éŸ³
            updatePageList(currentFilter);
            updateRelatedPagesList();
        }

        // æ–°è¦ä½œæˆ
        function newPage() {
            document.getElementById('title-input').value = '';
            document.getElementById('content-textarea').value = '';
            document.getElementById('title-input').focus();
            selectedIndex = -1;
            clearRelatedPagesHighlight();
            updatePageList('');
            updateRelatedPagesList();
        }

        // textareaã®ã‚«ãƒ¼ã‚½ãƒ«ãŒæœ€çµ‚è¡Œæœ«ã‹ã©ã†ã‹ã‚’ãƒã‚§ãƒƒã‚¯
        function isCursorAtEnd(textarea) {
            return textarea.selectionStart === textarea.value.length;
        }

        // ã‚«ãƒ¼ã‚½ãƒ«ãŒã‚ã‚‹è¡Œã®æ–‡å­—åˆ—ã‚’å–å¾—
        function getCurrentLine(textarea) {
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const text = textarea.value;
            const beforeCursor = text.substring(0, start);
            const lineBreakPos = beforeCursor.lastIndexOf('\n');
            const lineStart = lineBreakPos === -1 ? 0 : lineBreakPos + 1;
            const lineEnd = text.indexOf('\n', start);
            const line = lineEnd === -1 ? text.substring(lineStart) : text.substring(lineStart, lineEnd);
            return line.trim();
        }

        // JSONãƒ‡ãƒ¼ã‚¿ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
        function exportToJson() {
            const data = {};
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith('wiki_') && !key.startsWith('wiki_meta_')) {
                    const title = key.replace('wiki_', '');
                    data[title] = {
                        content: localStorage.getItem(key),
                        meta: JSON.parse(localStorage.getItem(`wiki_meta_${title}`) || '{}')
                    };
                }
            }
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'wiki_export.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // JSONãƒ‡ãƒ¼ã‚¿ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
        function importFromJson(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    const data = JSON.parse(e.target.result);
                    for (const title in data) {
                        localStorage.setItem(`wiki_${title}`, data[title].content);
                        localStorage.setItem(`wiki_meta_${title}`, JSON.stringify(data[title].meta || { updatedAt: Date.now() }));
                    }
                    alert('ã‚¤ãƒ³ãƒãƒ¼ãƒˆãŒå®Œäº†ã—ã¾ã—ãŸã€‚');
                    updatePageList(currentFilter);
                    updateRelatedPagesList();
                } catch (error) {
                    alert('ã‚¤ãƒ³ãƒãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
                }
            };
            reader.readAsText(file);
            event.target.value = ''; // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã‚’ãƒªã‚»ãƒƒãƒˆ
        }

        // inputã®å…¥åŠ›æ™‚ã«ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®å­˜åœ¨ã‚’ãƒã‚§ãƒƒã‚¯
        document.getElementById('title-input').addEventListener('input', function (e) {
            const title = e.target.value.trim();
            if (title) {
                const content = localStorage.getItem(`wiki_${title}`);
                if (content === null) {
                    document.getElementById('content-textarea').value = '';
                } else {
                    document.getElementById('content-textarea').value = content;
                }
            } else {
                document.getElementById('content-textarea').value = '';
            }
            savePage();
            updatePageList(currentFilter);
            updateRelatedPagesList();
        });

        // è‡ªå‹•ä¿å­˜ï¼ˆå†…å®¹ãŒå¤‰æ›´ã•ã‚ŒãŸã‚‰ä¿å­˜ï¼‰
        document.getElementById('content-textarea').addEventListener('input', function () {
            savePage();
            updateRelatedPagesList();
        });

        // IMEå…¥åŠ›ä¸­ã®ãƒ•ãƒ©ã‚°ç®¡ç†
        document.getElementById('title-input').addEventListener('compositionstart', () => {
            isIMEComposing = true;
        });

        document.getElementById('title-input').addEventListener('compositionend', () => {
            isIMEComposing = false;
        });

        // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ç§»å‹•æ™‚ã®æ›´æ–°
        document.getElementById('content-textarea').addEventListener('focus', updateRelatedPagesList);
        document.getElementById('title-input').addEventListener('focus', function () {
            document.getElementById('title-input').value = '';
            document.getElementById('content-textarea').value = '';
            updatePageList('');
            updateRelatedPagesList();
        });

        // inputã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸã¨ãã«ç©ºæ¬„ã«ã™ã‚‹
        document.getElementById('title-input').addEventListener('click', function () {
            document.getElementById('title-input').value = '';
            document.getElementById('content-textarea').value = '';
            updatePageList('');
            updateRelatedPagesList();
        });

        // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ
        document.addEventListener('keydown', function (e) {
            const inputElement = document.getElementById('title-input');
            const textareaElement = document.getElementById('content-textarea');

            // Shiftã‚­ãƒ¼ã‚’2å›æŠ¼ã—ãŸæ™‚ã®å‡¦ç†
            if (e.key === 'Shift') {
                if (shiftKeyPressCount === 0) {
                    shiftKeyPressCount++;
                    clearTimeout(shiftKeyPressTimeout);
                    shiftKeyPressTimeout = setTimeout(() => {
                        shiftKeyPressCount = 0;
                    }, 500);
                } else if (shiftKeyPressCount === 1 && document.activeElement === textareaElement) {
                    e.preventDefault();
                    const currentLine = getCurrentLine(textareaElement);
                    if (currentLine) {
                        const pageTitle = currentLine;
                        document.getElementById('title-input').value = pageTitle;
                        document.getElementById('content-textarea').value = '';
                        document.getElementById('content-textarea').focus();
                        playBeep(880, 0.1); // ç¢ºå®šæ™‚ã®é«˜ã„éŸ³
                    }
                    shiftKeyPressCount = 0;
                }
            }
            // Ctrl+Sã§ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
            else if (e.ctrlKey && e.key === 's') {
                e.preventDefault();
                exportToJson();
            }
            // Ctrl+Oã§ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
            else if (e.ctrlKey && e.key === 'o') {
                e.preventDefault();
                document.getElementById('file-input').click();
            }
            // textareaã§ä¸‹ã‚­ãƒ¼ã‚’æŠ¼ã—ãŸæ™‚ã®å‡¦ç†
            else if (document.activeElement === textareaElement && e.key === 'ArrowDown' && isCursorAtEnd(textareaElement)) {
                e.preventDefault();
                if (pageButtons.length === 0) return;

                // ãƒªã‚¹ãƒˆãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒ¢ãƒ¼ãƒ‰é–‹å§‹
                listNavigationMode = true;
                textareaElement.classList.add('list-navigation-mode');

                // 5ç§’å¾Œã«ãƒ¢ãƒ¼ãƒ‰ã‚’è§£é™¤
                clearTimeout(listNavigationTimeout);
                listNavigationTimeout = setTimeout(() => {
                    listNavigationMode = false;
                    textareaElement.classList.remove('list-navigation-mode');
                }, 5000);

                // é¸æŠè§£é™¤
                if (selectedIndex !== -1) {
                    pageButtons[selectedIndex].classList.remove('selected');
                }

                selectedIndex = selectedIndex === -1 || selectedIndex >= pageButtons.length - 1 ? 0 : selectedIndex + 1;
                pageButtons[selectedIndex].classList.add('selected');
                pageButtons[selectedIndex].scrollIntoView({ block: 'nearest' });
                playBeep(); // ç§»å‹•æ™‚ã®ãƒ“ãƒ¼ãƒ—éŸ³

                // é¸æŠã—ãŸãƒšãƒ¼ã‚¸ã®å†…å®¹ã‚’textareaã«åæ˜ 
                const selectedTitle = pageButtons[selectedIndex].textContent;
                const content = localStorage.getItem(`wiki_${selectedTitle}`);
                document.getElementById('title-input').value = selectedTitle;
                document.getElementById('content-textarea').value = content || '';
                updateRelatedPagesList();
            }
            // textareaã§ä¸Šã‚­ãƒ¼ã‚’æŠ¼ã—ãŸæ™‚ã®å‡¦ç†ï¼ˆãƒªã‚¹ãƒˆãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒ¢ãƒ¼ãƒ‰æ™‚ã®ã¿ï¼‰
            else if (document.activeElement === textareaElement && e.key === 'ArrowUp' && listNavigationMode) {
                e.preventDefault();
                if (pageButtons.length === 0) return;

                // é¸æŠè§£é™¤
                if (selectedIndex !== -1) {
                    pageButtons[selectedIndex].classList.remove('selected');
                }

                selectedIndex = selectedIndex <= 0 ? pageButtons.length - 1 : selectedIndex - 1;
                pageButtons[selectedIndex].classList.add('selected');
                pageButtons[selectedIndex].scrollIntoView({ block: 'nearest' });
                playBeep(); // ç§»å‹•æ™‚ã®ãƒ“ãƒ¼ãƒ—éŸ³

                // é¸æŠã—ãŸãƒšãƒ¼ã‚¸ã®å†…å®¹ã‚’textareaã«åæ˜ 
                const selectedTitle = pageButtons[selectedIndex].textContent;
                const content = localStorage.getItem(`wiki_${selectedTitle}`);
                document.getElementById('title-input').value = selectedTitle;
                document.getElementById('content-textarea').value = content || '';
                updateRelatedPagesList();
            }
            // textareaã§å³ã‚­ãƒ¼ã‚’æŠ¼ã—ãŸæ™‚ã®å‡¦ç†ï¼ˆé–¢é€£ãƒšãƒ¼ã‚¸ãƒªã‚¹ãƒˆã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ï¼‰
            else if (document.activeElement === textareaElement && e.key === 'ArrowRight' && isCursorAtEnd(textareaElement)) {
                e.preventDefault();
                if (relatedPageButtons.length === 0) return;

                // é–¢é€£ãƒšãƒ¼ã‚¸ãƒªã‚¹ãƒˆãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒ¢ãƒ¼ãƒ‰é–‹å§‹
                relatedListNavigationMode = true;
                clearPageListHighlight();

                // é–¢é€£ãƒšãƒ¼ã‚¸ãƒªã‚¹ãƒˆã®æœ€åˆã®é …ç›®ã‚’é¸æŠ
                relatedSelectedIndex = 0;
                relatedPageButtons[relatedSelectedIndex].classList.add('selected');
                relatedPageButtons[relatedSelectedIndex].focus();
                relatedPageButtons[relatedSelectedIndex].scrollIntoView({ block: 'nearest' });
                playBeep(); // ç§»å‹•æ™‚ã®ãƒ“ãƒ¼ãƒ—éŸ³

                // 5ç§’å¾Œã«ãƒ¢ãƒ¼ãƒ‰ã‚’è§£é™¤
                clearTimeout(relatedListNavigationTimeout);
                relatedListNavigationTimeout = setTimeout(() => {
                    relatedListNavigationMode = false;
                }, 5000);
            }
            // é–¢é€£ãƒšãƒ¼ã‚¸ãƒªã‚¹ãƒˆãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒ¢ãƒ¼ãƒ‰æ™‚ã®ä¸Šä¸‹ã‚­ãƒ¼å‡¦ç†
            else if (relatedListNavigationMode && e.key === 'ArrowUp') {
                e.preventDefault();
                if (relatedPageButtons.length === 0) return;

                // é¸æŠè§£é™¤
                if (relatedSelectedIndex !== -1) {
                    relatedPageButtons[relatedSelectedIndex].classList.remove('selected');
                }

                relatedSelectedIndex = relatedSelectedIndex <= 0 ? relatedPageButtons.length - 1 : relatedSelectedIndex - 1;
                relatedPageButtons[relatedSelectedIndex].classList.add('selected');
                relatedPageButtons[relatedSelectedIndex].focus();
                relatedPageButtons[relatedSelectedIndex].scrollIntoView({ block: 'nearest' });
                playBeep(); // ç§»å‹•æ™‚ã®ãƒ“ãƒ¼ãƒ—éŸ³
            }
            // é–¢é€£ãƒšãƒ¼ã‚¸ãƒªã‚¹ãƒˆãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒ¢ãƒ¼ãƒ‰æ™‚ã®ä¸‹ã‚­ãƒ¼å‡¦ç†
            else if (relatedListNavigationMode && e.key === 'ArrowDown') {
                e.preventDefault();
                if (relatedPageButtons.length === 0) return;

                // é¸æŠè§£é™¤
                if (relatedSelectedIndex !== -1) {
                    relatedPageButtons[relatedSelectedIndex].classList.remove('selected');
                }

                relatedSelectedIndex = relatedSelectedIndex === -1 || relatedSelectedIndex >= relatedPageButtons.length - 1 ? 0 : relatedSelectedIndex + 1;
                relatedPageButtons[relatedSelectedIndex].classList.add('selected');
                relatedPageButtons[relatedSelectedIndex].focus();
                relatedPageButtons[relatedSelectedIndex].scrollIntoView({ block: 'nearest' });
                playBeep(); // ç§»å‹•æ™‚ã®ãƒ“ãƒ¼ãƒ—éŸ³
            }
            // é–¢é€£ãƒšãƒ¼ã‚¸ãƒªã‚¹ãƒˆãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒ¢ãƒ¼ãƒ‰æ™‚ã®å·¦ã‚­ãƒ¼å‡¦ç†
            else if (relatedListNavigationMode && e.key === 'ArrowLeft') {
                e.preventDefault();
                // ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚’è§£é™¤
                if (relatedSelectedIndex !== -1) {
                    relatedPageButtons[relatedSelectedIndex].classList.remove('selected');
                    relatedSelectedIndex = -1;
                }
                // textareaã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚’æˆ»ã™
                document.getElementById('content-textarea').focus();
                relatedListNavigationMode = false;
            }
            // é–¢é€£ãƒšãƒ¼ã‚¸ãƒªã‚¹ãƒˆãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒ¢ãƒ¼ãƒ‰æ™‚ã®Enterã‚­ãƒ¼å‡¦ç†
            else if (relatedListNavigationMode && e.key === 'Enter') {
                e.preventDefault();
                if (relatedSelectedIndex !== -1) {
                    const selectedElement = relatedPageButtons[relatedSelectedIndex];
                    if (selectedElement.tagName === 'A') {
                        window.open(selectedElement.href, '_blank');
                        document.getElementById('content-textarea').focus();
                        playBeep(880, 0.1); // ç¢ºå®šæ™‚ã®é«˜ã„éŸ³
                    } else {
                        const selectedTitle = selectedElement.textContent;
                        const content = localStorage.getItem(`wiki_${selectedTitle}`);
                        document.getElementById('title-input').value = selectedTitle;
                        document.getElementById('content-textarea').value = content || '';
                        document.getElementById('content-textarea').focus();
                        playBeep(880, 0.1); // ç¢ºå®šæ™‚ã®é«˜ã„éŸ³
                    }
                    relatedListNavigationMode = false;
                }
            }
            // inputã§å³ã‚­ãƒ¼ã‚’æŠ¼ã—ãŸæ™‚ã®å‡¦ç†ï¼ˆé–¢é€£ãƒšãƒ¼ã‚¸ãƒªã‚¹ãƒˆã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ï¼‰
            else if (document.activeElement === inputElement && e.key === 'ArrowRight' && inputElement.selectionStart === inputElement.value.length) {
                e.preventDefault();
                if (relatedPageButtons.length === 0) return;

                // é–¢é€£ãƒšãƒ¼ã‚¸ãƒªã‚¹ãƒˆãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒ¢ãƒ¼ãƒ‰é–‹å§‹
                relatedListNavigationMode = true;
                clearPageListHighlight();

                // é–¢é€£ãƒšãƒ¼ã‚¸ãƒªã‚¹ãƒˆã®æœ€åˆã®é …ç›®ã‚’é¸æŠ
                relatedSelectedIndex = 0;
                relatedPageButtons[relatedSelectedIndex].classList.add('selected');
                relatedPageButtons[relatedSelectedIndex].focus();
                relatedPageButtons[relatedSelectedIndex].scrollIntoView({ block: 'nearest' });
                playBeep(); // ç§»å‹•æ™‚ã®ãƒ“ãƒ¼ãƒ—éŸ³

                // 5ç§’å¾Œã«ãƒ¢ãƒ¼ãƒ‰ã‚’è§£é™¤
                clearTimeout(relatedListNavigationTimeout);
                relatedListNavigationTimeout = setTimeout(() => {
                    relatedListNavigationMode = false;
                }, 5000);
            }
            // é–¢é€£ãƒšãƒ¼ã‚¸ãƒªã‚¹ãƒˆãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒ¢ãƒ¼ãƒ‰æ™‚ã®ä¸Šä¸‹ã‚­ãƒ¼å‡¦ç†
            else if (relatedListNavigationMode && (e.key === 'ArrowUp' || e.key === 'ArrowDown')) {
                e.preventDefault();
                if (relatedPageButtons.length === 0) return;

                // é¸æŠè§£é™¤
                if (relatedSelectedIndex !== -1) {
                    relatedPageButtons[relatedSelectedIndex].classList.remove('selected');
                }

                if (e.key === 'ArrowUp') {
                    relatedSelectedIndex = relatedSelectedIndex <= 0 ? relatedPageButtons.length - 1 : relatedSelectedIndex - 1;
                } else if (e.key === 'ArrowDown') {
                    relatedSelectedIndex = relatedSelectedIndex === -1 || relatedSelectedIndex >= relatedPageButtons.length - 1 ? 0 : relatedSelectedIndex + 1;
                }

                // é¸æŠé©ç”¨
                if (relatedSelectedIndex !== -1) {
                    relatedPageButtons[relatedSelectedIndex].classList.add('selected');
                    relatedPageButtons[relatedSelectedIndex].focus();
                    relatedPageButtons[relatedSelectedIndex].scrollIntoView({ block: 'nearest' });
                    playBeep(); // ç§»å‹•æ™‚ã®ãƒ“ãƒ¼ãƒ—éŸ³
                }
            }
            // é–¢é€£ãƒšãƒ¼ã‚¸ãƒªã‚¹ãƒˆãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒ¢ãƒ¼ãƒ‰æ™‚ã®Enterã‚­ãƒ¼å‡¦ç†
            else if (relatedListNavigationMode && e.key === 'Enter') {
                e.preventDefault();
                if (relatedSelectedIndex !== -1) {
                    const selectedElement = relatedPageButtons[relatedSelectedIndex];
                    if (selectedElement.tagName === 'A') {
                        window.open(selectedElement.href, '_blank');
                        document.getElementById('content-textarea').focus();
                        playBeep(880, 0.1); // ç¢ºå®šæ™‚ã®é«˜ã„éŸ³
                    } else {
                        const selectedTitle = selectedElement.textContent;
                        const content = localStorage.getItem(`wiki_${selectedTitle}`);
                        document.getElementById('title-input').value = selectedTitle;
                        document.getElementById('content-textarea').value = content || '';
                        document.getElementById('content-textarea').focus();
                        playBeep(880, 0.1); // ç¢ºå®šæ™‚ã®é«˜ã„éŸ³
                    }
                    relatedListNavigationMode = false;
                }
            }
            // IMEå…¥åŠ›ä¸­ã§ãªã„å ´åˆã®ã¿Enterã‚­ãƒ¼ã§textareaã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ï¼ˆtextareaã‚’ç©ºæ¬„ã«ã™ã‚‹ï¼‰
            else if (document.activeElement === inputElement && e.key === 'Enter' && !isIMEComposing) {
                e.preventDefault();
                document.getElementById('content-textarea').value = '';
                document.getElementById('content-textarea').focus();
                updatePageList(currentFilter);
                updateRelatedPagesList();
            }
            // ä¸Šä¸‹ã‚­ãƒ¼ã§ãƒšãƒ¼ã‚¸ãƒªã‚¹ãƒˆã‚’ç§»å‹•
            else if (document.activeElement === inputElement && (e.key === 'ArrowUp' || e.key === 'ArrowDown')) {
                e.preventDefault();
                if (pageButtons.length === 0) return;

                // é¸æŠè§£é™¤
                if (selectedIndex !== -1) {
                    pageButtons[selectedIndex].classList.remove('selected');
                }

                if (e.key === 'ArrowUp') {
                    selectedIndex = selectedIndex <= 0 ? pageButtons.length - 1 : selectedIndex - 1;
                } else if (e.key === 'ArrowDown') {
                    selectedIndex = selectedIndex === -1 || selectedIndex >= pageButtons.length - 1 ? 0 : selectedIndex + 1;
                }

                // é¸æŠé©ç”¨
                if (selectedIndex !== -1) {
                    pageButtons[selectedIndex].classList.add('selected');
                    pageButtons[selectedIndex].scrollIntoView({ block: 'nearest' });
                    playBeep(); // ç§»å‹•æ™‚ã®ãƒ“ãƒ¼ãƒ—éŸ³

                    // é¸æŠã—ãŸãƒšãƒ¼ã‚¸ã®å†…å®¹ã‚’textareaã«åæ˜ 
                    const selectedTitle = pageButtons[selectedIndex].textContent;
                    const content = localStorage.getItem(`wiki_${selectedTitle}`);
                    document.getElementById('title-input').value = selectedTitle;
                    document.getElementById('content-textarea').value = content || '';
                    updateRelatedPagesList();
                }
            }
            // Tabã‚­ãƒ¼ã§textareaã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹
            else if (document.activeElement === inputElement && e.key === 'Tab') {
                e.preventDefault();
                document.getElementById('content-textarea').focus();
            }
            // textareaã§Tabã‚­ãƒ¼ã‚’æŠ¼ã—ãŸã‚‰inputã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ï¼ˆç©ºæ¬„ã«ã—ã€ãƒªã‚¹ãƒˆã‚’æ›´æ–°ï¼‰
            else if (document.activeElement === textareaElement && e.key === 'Tab') {
                e.preventDefault();
                document.getElementById('title-input').value = '';
                document.getElementById('content-textarea').value = '';
                document.getElementById('title-input').focus();
                updatePageList('');
                updateRelatedPagesList();
            }
        });

        // inputã®çµã‚Šè¾¼ã¿æ©Ÿèƒ½
        document.getElementById('title-input').addEventListener('input', function (e) {
            if (!isMouseOverList) {
                updatePageList(e.target.value);
            }
        });

        // å…¨è§’æ•°å­—ã‚’åŠè§’æ•°å­—ã«å¤‰æ›
        document.getElementById('title-input').addEventListener('input', function (e) {
            let value = e.target.value;
            let newValue = value.replace(/ï¼»ï¼-ï¼™ï¼½/g, function (s) {
                return String.fromCharCode(s.charCodeAt(0) - 0xFEE0);
            }).replace(/[ï¼-ï¼™]/g, function (s) {
                return String.fromCharCode(s.charCodeAt(0) - 0xFEE0);
            });
            if (value !== newValue) {
                e.target.value = newValue;
                const event = new Event('input', { bubbles: true });
                e.target.dispatchEvent(event);
            }
        });

        // inputå†…ã§ã€Œãƒ»ã€ãŒå…¥åŠ›ã•ã‚ŒãŸéš›ã€è¡Œé ­ãŒæ•°å­—ã§å§‹ã¾ã‚‹å ´åˆã«ã€Œ/ã€ã«å³æ™‚ç½®æ›
        document.getElementById('title-input').addEventListener('input', function (e) {
            const input = e.target;
            const cursorPos = input.selectionStart;
            const text = input.value;
            const lastChar = text[cursorPos - 1];

            if (lastChar === 'ãƒ»') {
                // è¡Œé ­ãŒæ•°å­—ã§å§‹ã¾ã‚‹å ´åˆ
                if (/^\d/.test(text)) {
                    const newText = text.substring(0, cursorPos - 1) + '/' + text.substring(cursorPos);
                    input.value = newText;
                    input.selectionStart = cursorPos;
                    input.selectionEnd = cursorPos;

                    // ã‚¤ãƒ™ãƒ³ãƒˆã‚’ãƒˆãƒªã‚¬ãƒ¼ã—ã¦å¤‰æ›´ã‚’åæ˜ 
                    const event = new Event('input', { bubbles: true });
                    input.dispatchEvent(event);
                }
            }
        });

        // ãƒšãƒ¼ã‚¸ãƒªã‚¹ãƒˆã«ãƒã‚¦ã‚¹ãŒä¹—ã£ãŸ/é›¢ã‚ŒãŸæ™‚ã®å‡¦ç†
        document.getElementById('page-list').addEventListener('mouseenter', () => {
            isMouseOverList = true;
        });
        document.getElementById('page-list').addEventListener('mouseleave', () => {
            isMouseOverList = false;
            updatePageList(document.getElementById('title-input').value);
            updateRelatedPagesList();
        });

        // ãƒ•ã‚¡ã‚¤ãƒ«ã‚¤ãƒ³ãƒãƒ¼ãƒˆã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        document.getElementById('file-input').addEventListener('change', importFromJson);

        // ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        document.getElementById('export-button').addEventListener('click', exportToJson);

        // ã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        document.getElementById('import-button').addEventListener('click', () => {
            document.getElementById('file-input').click();
        });

        // ãƒšãƒ¼ã‚¸ã®ç©ºç™½éƒ¨åˆ†ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸéš›ã®ãƒ•ã‚©ãƒ¼ã‚«ã‚¹åˆ¶å¾¡
        document.addEventListener('click', function (e) {
            if (e.target === document.body || e.target === document.documentElement) {
                const textarea = document.getElementById('content-textarea');
                const input = document.getElementById('title-input');
                if (textarea.value.trim() === '') {
                    input.focus();
                } else {
                    textarea.focus();
                }
            }
        });

        // ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ãŒå¾©æ´»ã—ãŸã¨ãã®å‡¦ç†
        window.addEventListener('focus', function () {
            const textarea = document.getElementById('content-textarea');
            const input = document.getElementById('title-input');
            if (textarea.value.trim() === '') {
                input.focus();
            } else {
                textarea.focus();
            }
        });

        // åˆæœŸè¡¨ç¤º
        window.addEventListener('load', function () {
            cleanEmptyEntries();
            const lastOpenedTitle = localStorage.getItem(LAST_OPENED_KEY);
            if (lastOpenedTitle) {
                loadPage(lastOpenedTitle);
            } else {
                document.getElementById('title-input').focus();
            }
            updatePageList();
            updateRelatedPagesList();
        });
    </script>
</body>

</html>