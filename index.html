<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no, maximum-scale=1.0">
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üêπ</text></svg>" />
    <title>mogr</title>
    <style>
        ::-webkit-scrollbar {
            display: none;
        }

        body {
            font-family: 'Yu Mincho', 'Hiragino Mincho Pro', serif;
            background-color: #f5f5dc;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 0;
            min-height: 100vh;
            margin: 0;
            position: relative;
            overflow-y: hidden;
            touch-action: manipulation;
        }

        .side-buttons {
            position: fixed;
            left: 10px;
            bottom: 1%;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 30;
            opacity: 0.2;
        }

        .side-button {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: none;
            background-color: #fff8dc;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 15px;
        }

        .side-button:hover {
            background-color: #e8e8c8;
        }

        .input-container {
            width: 90%;
            max-width: 600px;
            margin-bottom: 10px;
            padding-top: 20px;
        }

        .title-input {
            outline: none;
            text-align: center;
            width: 100%;
            padding: 12px;
            font-size: 24px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: #fff8dc;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .content-textarea-wrapper {
            width: 90%;
            max-width: 600px;
            margin-bottom: 20px;
            position: relative;
        }

        .content-textarea {
            outline: none;
            width: 100%;
            height: 30vh;
            padding: 12px;
            font-size: 16px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: #fff8dc;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            resize: none;
            line-height: 25px;
        }

        .related-pages-container {
            position: fixed;
            right: 10px;
            bottom: 70px;
            width: 300px;
            background-color: #fff8dc;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            z-index: 20;
            max-height: 300px;
            overflow-y: auto;
            overflow-x: hidden;
            display: none;
        }

        .related-pages-container.show {
            display: block;
        }

        .related-pages-list {
            list-style: none;
            padding: 0;
            margin: 0;
            white-space: nowrap;
        }

        .related-pages-list button,
        .related-pages-list a.related-url-button {
            display: block;
            width: 100%;
            text-align: left;
            padding: 8px;
            margin: 0;
            background-color: transparent;
            border: none;
            cursor: pointer;
            border-bottom: 1px solid #eee;
            text-align: left;
            text-decoration: none;
            color: #333;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .related-pages-list a.related-url-button {
            color: #0066cc;
        }

        .related-pages-list button:hover,
        .related-pages-list button.selected,
        .related-pages-list a.related-url-button:hover,
        .related-pages-list a.related-url-button.selected {
            background-color: #e8e8c8;
        }

        .related-pages-list button:focus,
        .related-pages-list a.related-url-button:focus {
            outline: 2px solid #ff6b6b;
        }

        ::selection {
            background-color: #ffff99;
        }

        .title-input,
        .content-textarea {
            caret-color: #ff6b6b;
            transition: caret-color 0.3s;
        }

        .content-textarea.list-navigation-mode {
            caret-color: blue;
        }

        .page-list-container {
            width: 90%;
            max-width: 600px;
            border: 1px solid transparent;
            padding: 5px 2px 10px 25px;
            margin-bottom: 80px;
        }

        .page-list {
            display: block;
            position: static;
            background-color: #fff8dc;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            z-index: 10;
            width: 100%;
            max-height: 50vh;
            overflow-y: auto;
        }

        .page-list button {
            text-align: center !important;
            display: block;
            width: 100%;
            text-align: left;
            padding: 8px;
            margin: 5px 0;
            background-color: #fff8dc;
            border: none;
            cursor: pointer;
        }

        .page-list button:hover,
        .page-list button.selected {
            background-color: #e8e8c8;
        }

        .highlight {
            background-color: #ffff99;
            font-weight: bold;
        }

        #file-input {
            display: none;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .modal-content {
            background-color: #fff8dc;
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            width: 80%;
            max-width: 500px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
        }

        .modal-form {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .modal-form input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .modal-form button {
            padding: 10px;
            background-color: #fff8dc;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
        }

        .modal-form button:hover {
            background-color: #e8e8c8;
        }

        .info-button {
            position: fixed;
            right: 10px;
            bottom: 1%;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: none;
            background-color: #fff8dc;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            z-index: 30;
            opacity: 0.2;
        }

        .info-button:hover {
            opacity: 1;
            background-color: #e8e8c8;
        }

        .sync-status {
            position: fixed;
            right: 70px;
            bottom: 1%;
            background-color: #fff8dc;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            z-index: 30;
            opacity: 0.7;
        }

        @media (max-width: 768px) {
            body {
                padding: 0;
                overflow-y: auto;
            }

            .side-buttons {
                left: 5px;
                bottom: 5px;
            }

            .side-button {
                width: 40px;
                height: 40px;
                font-size: 12px;
            }

            .input-container {
                width: 95%;
                padding: 0;
                box-sizing: border-box;
                padding-top: 10px;
            }

            .title-input {
                font-size: 18px;
                padding: 10px;
                width: 100%;
            }

            .content-textarea-wrapper {
                width: 95%;
                padding: 0;
                box-sizing: border-box;
            }

            .content-textarea {
                height: 40vh;
                font-size: 14px;
                padding: 10px;
                width: 100%;
            }

            .page-list-container {
                width: 95%;
                padding: 0;
                box-sizing: border-box;
                margin-bottom: 70px;
            }

            .page-list {
                max-height: 40vh;
                width: 100%;
            }

            .page-list button {
                padding: 6px;
                font-size: 14px;
                width: 100%;
            }

            .related-pages-container {
                position: fixed;
                right: 5px;
                left: 5px;
                bottom: 60px;
                width: calc(100% - 10px);
                max-height: 30vh;
            }

            .related-pages-list button,
            .related-pages-list a.related-url-button {
                padding: 6px;
                font-size: 14px;
            }

            .related-pages-list>img {
                max-width: 100%;
                max-height: 120px;
                margin: 5px 0;
                border-radius: 4px;
                object-fit: contain;
                display: block;
            }


            .info-button {
                right: 5px;
                bottom: 5px;
                width: 40px;
                height: 40px;
                font-size: 16px;
            }

            .sync-status {
                right: 50px;
                bottom: 5px;
                font-size: 10px;
            }

            .modal-content {
                margin: 20% auto;
                width: 95%;
                padding: 15px;
            }

            .modal-form input {
                padding: 6px;
                font-size: 14px;
                width: 100%;
                box-sizing: border-box;
            }

            .modal-form button {
                padding: 8px;
                font-size: 14px;
                width: 100%;
            }
        }

        /* „Éï„Ç©„Éº„Ç´„ÇπÊôÇ„ÅÆ„Çπ„Çø„Ç§„É´Ë™øÊï¥ */
        .title-input:focus+.content-textarea-wrapper .content-textarea {
            display: none;
        }
    </style>
</head>

<body>
    <div class="input-container">
        <input type="text" id="title-input" class="title-input" placeholder="„Çø„Ç§„Éà„É´„ÇíÂÖ•Âäõ..." autocomplete="off">
    </div>
    <div class="content-textarea-wrapper">
        <textarea id="content-textarea" class="content-textarea" placeholder="Wiki„ÅÆÂÜÖÂÆπ„ÇíÂÖ•Âäõ..."></textarea>
        <div class="related-pages-container" id="related-pages-container">
            <div class="related-pages-list" id="related-pages-list"></div>
        </div>
    </div>
    <div class="page-list-container">
        <div class="page-list" id="page-list"></div>
    </div>
    <input type="file" id="file-input" accept=".json">

    <button class="info-button" id="info-button">i</button>
    <div class="sync-status" id="sync-status">Êú™ÂêåÊúü</div>

    <div id="settings-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Ë®≠ÂÆö</h2>
                <button class="modal-close" id="modal-close">&times;</button>
            </div>
            <div class="modal-form">
                <h3>GitHubÂêåÊúüË®≠ÂÆö</h3>
                <input type="text" id="github-username" placeholder="GitHub„É¶„Éº„Ç∂„ÉºÂêç">
                <input type="text" id="github-repo" placeholder="„É™„Éù„Ç∏„Éà„É™Âêç">
                <input type="text" id="github-file" placeholder="„Éï„Ç°„Ç§„É´Âêç (‰æã: wiki.json)">
                <input type="password" id="github-token" placeholder="GitHub„Éà„Éº„ÇØ„É≥">
                <button id="save-github-settings">Ë®≠ÂÆö„Çí‰øùÂ≠ò</button>
                <button id="sync-to-github">GitHub„Å´ÂêåÊúü</button>
                <button id="sync-from-github">GitHub„Åã„ÇâÂêåÊúü</button>
                <hr>
                <h3>„É≠„Éº„Ç´„É´ÂÖ•Âá∫Âäõ</h3>
                <button id="export-button">„Ç®„ÇØ„Çπ„Éù„Éº„Éà (Ctrl+S)</button>
                <button id="import-button">„Ç§„É≥„Éù„Éº„Éà (Ctrl+O)</button>
            </div>
        </div>
    </div>


</body>
<script>
    // Áä∂ÊÖãÁÆ°ÁêÜ„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà
        const state = {
            isIMEComposing: false,
            selectedIndex: -1,
            relatedSelectedIndex: -1,
            pageButtons: [],
            relatedPageButtons: [],
            currentFilter: '',
            listNavigationMode: false,
            relatedListNavigationMode: false,
            listNavigationTimeout: null,
            relatedListNavigationTimeout: null,
            audioContext: null,
            lastHoveredTitle: null,
            shiftKeyPressCount: 0,
            shiftKeyPressTimeout: null,
            githubSettings: {
                username: '',
                repo: '',
                file: 'wiki.json',
                token: ''
            }
        };

        // „Çπ„Éà„É¨„Éº„Ç∏ÁÆ°ÁêÜ„É¢„Ç∏„É•„Éº„É´
        const storage = {
            cleanEmptyEntries: function () {
                for (let i = localStorage.length - 1; i >= 0; i--) {
                    const key = localStorage.key(i);
                    if (key.startsWith('wiki_')) {
                        const content = localStorage.getItem(key);
                        if (!content) {
                            localStorage.removeItem(key);
                            localStorage.removeItem(`wiki_meta_${key.replace('wiki_', '')}`);
                        }
                    }
                }
            },
            getPage: function (title) {
                return localStorage.getItem(`wiki_${title}`);
            },
            savePage: function (title, content) {
                localStorage.setItem(`wiki_${title}`, content);
                const metaKey = `wiki_meta_${title}`;
                localStorage.setItem(metaKey, JSON.stringify({ updatedAt: Date.now() }));
            },
            deletePage: function (title) {
                localStorage.removeItem(`wiki_${title}`);
                localStorage.removeItem(`wiki_meta_${title}`);
            },
            getAllPages: function () {
                const pages = [];
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key.startsWith('wiki_') && !key.startsWith('wiki_meta_')) {
                        const title = key.replace('wiki_', '');
                        const metaKey = `wiki_meta_${title}`;
                        const meta = JSON.parse(localStorage.getItem(metaKey) || '{"updatedAt": 0}');
                        pages.push({ title, updatedAt: meta.updatedAt });
                    }
                }
                return pages;
            }
        };

        // UIÁÆ°ÁêÜ„É¢„Ç∏„É•„Éº„É´
        const ui = {
            updatePageList: function (filter = '') {
                state.currentFilter = filter;
                const pageList = document.getElementById('page-list');
                pageList.innerHTML = '';
                const pages = storage.getAllPages();

                // Áµû„ÇäËæº„ÅøÊôÇ„ÅØ„Ç¢„É´„Éï„Ç°„Éô„ÉÉ„ÉàÈ†Ü„ÄÅ„Åù„Çå‰ª•Â§ñ„ÅØÊõ¥Êñ∞Êó•ÊôÇÈ†Ü
                pages.sort((a, b) => {
                    const extractDateParts = (title) => {
                        const match = title.match(/(\d+)\/(\d+)/);
                        if (!match) return [Infinity, Infinity];
                        const month = parseInt(match[1], 10);
                        const day = parseInt(match[2], 10);
                        return [month, day];
                    };
                    const [monthA, dayA] = extractDateParts(a.title);
                    const [monthB, dayB] = extractDateParts(b.title);
                    if (monthA !== monthB) {
                        return monthA - monthB;
                    }
                    return dayA - dayB;
                });

                state.pageButtons = [];
                pages.forEach((page) => {
                    if (filter && !page.title.includes(filter)) return;

                    const button = document.createElement('button');
                    if (filter) {
                        const regex = new RegExp(filter, 'gi');
                        button.innerHTML = page.title.replace(regex, match => `<span class="highlight">${match}</span>`);
                    } else {
                        button.textContent = page.title;
                    }
                    button.onclick = () => eventHandlers.onClickPageList(page.title);
                    button.onmouseenter = () => {
                        if (state.lastHoveredTitle !== page.title) {
                            playBeep();
                            state.lastHoveredTitle = page.title;
                            eventHandlers.onHoverPageList(page.title);
                        }
                    };
                    button.ondblclick = (e) => {
                        e.stopPropagation();
                        if (confirm(`${page.title}„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü`)) {
                            storage.deletePage(page.title);
                            if (document.getElementById('title-input').value === page.title) {
                                document.getElementById('title-input').value = '';
                                document.getElementById('content-textarea').value = '';
                                history.replaceState({ title: '' }, '', '#');
                            }
                            ui.updatePageList(filter);
                        }
                    };
                    pageList.appendChild(button);
                    state.pageButtons.push(button);
                });

                if (state.selectedIndex >= 0 && state.selectedIndex < state.pageButtons.length) {
                    state.pageButtons[state.selectedIndex].classList.add('selected');
                } else {
                    state.selectedIndex = -1;
                }
            },
            updateRelatedPagesList: function () {
                const textarea = document.getElementById('content-textarea');
                const container = document.getElementById('related-pages-container');
                const list = document.getElementById('related-pages-list');
                const text = textarea.value;
                const currentTitle = document.getElementById('title-input').value.trim();

                list.innerHTML = '';
                state.relatedPageButtons = [];

                const pages = storage.getAllPages();
                const foundTitles = [];
                pages.forEach(page => {
                    if (page.title === currentTitle) return;
                    const titleInContent = text.includes(page.title);
                    const contentInTitle = storage.getPage(page.title).includes(currentTitle);
                    if (titleInContent || contentInTitle) {
                        foundTitles.push(page);
                    }
                });

                foundTitles.forEach(page => {
                    const pageButton = document.createElement('button');
                    pageButton.textContent = page.title;
                    pageButton.onclick = () => {
                        ui.clearPageListHighlight();
                        eventHandlers.onClickPageList(page.title);
                        ui.clearRelatedPagesHighlight();
                    };
                    list.appendChild(pageButton);
                    state.relatedPageButtons.push(pageButton);
                });

                const urlRegex = /(https?:\/\/[^\s]+)/g;
                const imageUrlRegex = /\.(jpeg|jpg|gif|png|webp|svg)$/i;
                const urls = text.match(urlRegex);
                if (urls) {
                    urls.forEach(url => {
                        if (imageUrlRegex.test(url)) {
                            const img = document.createElement('img');
                            img.src = url;
                            img.alt = 'Èñ¢ÈÄ£ÁîªÂÉè';
                            img.loading = 'lazy';
                            img.onclick = () => {
                                window.open(url, '_blank');
                                document.getElementById('content-textarea').focus();
                            };
                            list.appendChild(img);
                            state.relatedPageButtons.push(img);
                        } else {
                            const urlButton = document.createElement('a');
                            urlButton.href = url;
                            urlButton.textContent = url;
                            urlButton.target = '_blank';
                            urlButton.rel = 'noopener noreferrer';
                            urlButton.classList.add('related-url-button');
                            urlButton.onclick = (e) => {
                                e.preventDefault();
                                window.open(urlButton.href, '_blank');
                                document.getElementById('content-textarea').focus();
                            };
                            list.appendChild(urlButton);
                            state.relatedPageButtons.push(urlButton);
                        }
                    });
                }

                if (foundTitles.length > 0 || urls) {
                    container.classList.add('show');
                } else {
                    container.classList.remove('show');
                }
            },
            clearPageListHighlight: function () {
                state.pageButtons.forEach(button => {
                    button.classList.remove('selected');
                });
                state.selectedIndex = -1;
            },
            clearRelatedPagesHighlight: function () {
                state.relatedPageButtons.forEach(button => {
                    if (button.classList) {
                        button.classList.remove('selected');
                    }
                });
                state.relatedSelectedIndex = -1;
            },
            loadPage: function (title, pushState = true) {
                const content = storage.getPage(title);
                document.getElementById('title-input').value = title;
                document.getElementById('content-textarea').value = content || '';
                document.getElementById('content-textarea').focus();
                state.selectedIndex = -1;
                ui.clearRelatedPagesHighlight();
                playBeep(880, 0.1);
                ui.updatePageList(state.currentFilter);
                ui.updateRelatedPagesList();
                eventHandlers.updateHash(title, pushState);
            },
            newPage: function () {
                document.getElementById('title-input').value = '';
                document.getElementById('content-textarea').value = '';
                document.getElementById('title-input').focus();
                state.selectedIndex = -1;
                ui.clearRelatedPagesHighlight();
                ui.updatePageList('');
                ui.updateRelatedPagesList();
                history.replaceState({ title: '' }, '', '#');
            }
        };

        // GitHubÂêåÊúü„É¢„Ç∏„É•„Éº„É´
        const github = {
            saveSettings: function () {
                state.githubSettings = {
                    username: document.getElementById('github-username').value.trim(),
                    repo: document.getElementById('github-repo').value.trim(),
                    file: document.getElementById('github-file').value.trim() || 'wiki.json',
                    token: document.getElementById('github-token').value.trim()
                };
                localStorage.setItem('github_settings', JSON.stringify(state.githubSettings));
                alert('GitHubË®≠ÂÆö„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü„ÄÇ');
            },
            loadSettings: function () {
                const savedSettings = localStorage.getItem('github_settings');
                if (savedSettings) {
                    state.githubSettings = JSON.parse(savedSettings);
                    document.getElementById('github-username').value = state.githubSettings.username;
                    document.getElementById('github-repo').value = state.githubSettings.repo;
                    document.getElementById('github-file').value = state.githubSettings.file;
                    document.getElementById('github-token').value = state.githubSettings.token;
                    if (state.githubSettings.username && state.githubSettings.repo && state.githubSettings.token) {
                        document.getElementById('sync-status').style.display = 'block';
                    } else {
                        document.getElementById('sync-status').style.display = 'none';
                    }
                } else {
                    document.getElementById('sync-status').style.display = 'none';
                }
            },
            syncToGithub: async function () {
                if (!state.githubSettings.username || !state.githubSettings.repo || !state.githubSettings.token) {
                    document.getElementById('sync-status').style.display = 'none';
                    return;
                }

                document.getElementById('sync-status').textContent = 'ÂêåÊúü‰∏≠...';
                document.getElementById('sync-status').style.display = 'block';

                const data = {};
                const pages = storage.getAllPages();
                pages.forEach(page => {
                    data[page.title] = {
                        content: storage.getPage(page.title),
                        meta: JSON.parse(localStorage.getItem(`wiki_meta_${page.title}`) || '{}')
                    };
                });

                const content = JSON.stringify(data, null, 2);
                const encodedContent = btoa(unescape(encodeURIComponent(content)));
                const url = `https://api.github.com/repos/${state.githubSettings.username}/${state.githubSettings.repo}/contents/${state.githubSettings.file}`;

                try {
                    let fileSha = '';
                    const response = await fetch(url, {
                        headers: {
                            'Authorization': `token ${state.githubSettings.token}`,
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    });

                    if (response.ok) {
                        const fileData = await response.json();
                        fileSha = fileData.sha;
                    }

                    const updateResponse = await fetch(url, {
                        method: 'PUT',
                        headers: {
                            'Authorization': `token ${state.githubSettings.token}`,
                            'Accept': 'application/vnd.github.v3+json',
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            message: 'Update wiki data',
                            content: encodedContent,
                            sha: fileSha
                        })
                    });

                    if (updateResponse.ok) {
                        document.getElementById('sync-status').textContent = 'ÂêåÊúüÂÆå‰∫Ü: ' + new Date().toLocaleString();
                    } else {
                        const error = await updateResponse.json();
                        document.getElementById('sync-status').textContent = 'ÂêåÊúüÂ§±Êïó: ' + new Date().toLocaleString();
                    }
                } catch (error) {
                    document.getElementById('sync-status').textContent = 'ÂêåÊúü„Ç®„É©„Éº: ' + new Date().toLocaleString();
                }
            },
            syncFromGithub: async function () {
                if (!state.githubSettings.username || !state.githubSettings.repo || !state.githubSettings.token) {
                    return false;
                }

                document.getElementById('sync-status').textContent = 'ÂêåÊúü‰∏≠...';
                document.getElementById('sync-status').style.display = 'block';

                const url = `https://api.github.com/repos/${state.githubSettings.username}/${state.githubSettings.repo}/contents/${state.githubSettings.file}`;

                try {
                    const response = await fetch(url, {
                        headers: {
                            'Authorization': `token ${state.githubSettings.token}`,
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    });

                    if (response.ok) {
                        const fileData = await response.json();
                        const content = decodeURIComponent(escape(atob(fileData.content)));
                        const data = JSON.parse(content);

                        for (const title in data) {
                            storage.savePage(title, data[title].content);
                            localStorage.setItem(`wiki_meta_${title}`, JSON.stringify(data[title].meta || { updatedAt: Date.now() }));
                        }

                        document.getElementById('sync-status').textContent = 'ÂêåÊúüÂÆå‰∫Ü: ' + new Date().toLocaleString();
                        return true;
                    } else {
                        const error = await response.json();
                        document.getElementById('sync-status').textContent = 'ÂêåÊúüÂ§±Êïó: ' + new Date().toLocaleString();
                        return false;
                    }
                } catch (error) {
                    document.getElementById('sync-status').textContent = 'ÂêåÊúü„Ç®„É©„Éº: ' + new Date().toLocaleString();
                    return false;
                }
            }
        };

        // „Ç§„Éô„É≥„Éà„Éè„É≥„Éâ„É©„É¢„Ç∏„É•„Éº„É´
        const eventHandlers = {
            onTitleInput: function (e) {
                const title = e.target.value.trim();
                if (title) {
                    const content = storage.getPage(title);
                    if (content === null) {
                        document.getElementById('content-textarea').value = '';
                    } else {
                        document.getElementById('content-textarea').value = content;
                    }
                } else {
                    document.getElementById('content-textarea').value = '';
                }
                storage.savePage(title, document.getElementById('content-textarea').value);
                ui.updatePageList(title);
                ui.updateRelatedPagesList();
            },
            onContentInput: function () {
                storage.savePage(document.getElementById('title-input').value.trim(), document.getElementById('content-textarea').value);
                ui.updateRelatedPagesList();
            },
            onKeyDown: function (e) {
                const inputElement = document.getElementById('title-input');
                const textareaElement = document.getElementById('content-textarea');

                if (e.key === 'Shift') {
                    if (state.shiftKeyPressCount === 0) {
                        state.shiftKeyPressCount++;
                        clearTimeout(state.shiftKeyPressTimeout);
                        state.shiftKeyPressTimeout = setTimeout(() => {
                            state.shiftKeyPressCount = 0;
                        }, 500);
                    } else if (state.shiftKeyPressCount === 1 && document.activeElement === textareaElement) {
                        e.preventDefault();
                        const currentLine = getCurrentLine(textareaElement);
                        if (currentLine.startsWith('http')) {
                            window.open(currentLine, '_blank');
                            textareaElement.focus();
                        } else if (currentLine) {
                            const pageTitle = currentLine;
                            const content = storage.getPage(pageTitle);
                            document.getElementById('title-input').value = pageTitle;
                            document.getElementById('content-textarea').value = content || '';
                            document.getElementById('content-textarea').focus();
                            playBeep(880, 0.1);
                            eventHandlers.updateHash(pageTitle, true);
                        }
                        state.shiftKeyPressCount = 0;
                    } else if (state.shiftKeyPressCount === 1 && document.activeElement === inputElement && inputElement.value.trim() === '') {
                        e.preventDefault();
                        const today = new Date();
                        const month = today.getMonth() + 1;
                        const day = today.getDate();
                        inputElement.value = `${month}/${day}`;
                        const content = storage.getPage(inputElement.value);
                        document.getElementById('content-textarea').value = content || '';
                        document.getElementById('content-textarea').focus();
                        ui.updatePageList(inputElement.value);
                        state.shiftKeyPressCount = 0;
                    }
                } else if (e.ctrlKey && e.key === 's') {
                    e.preventDefault();
                    exportToJson();
                } else if (e.ctrlKey && e.key === 'o') {
                    e.preventDefault();
                    document.getElementById('file-input').click();
                } else if (document.activeElement === textareaElement && e.key === 'ArrowDown' && isCursorAtEnd(textareaElement)) {
                    e.preventDefault();
                    if (state.pageButtons.length === 0) return;
                    state.listNavigationMode = true;
                    textareaElement.classList.add('list-navigation-mode');
                    clearTimeout(state.listNavigationTimeout);
                    state.listNavigationTimeout = setTimeout(() => {
                        state.listNavigationMode = false;
                        textareaElement.classList.remove('list-navigation-mode');
                    }, 5000);
                    if (state.selectedIndex !== -1) {
                        state.pageButtons[state.selectedIndex].classList.remove('selected');
                    }
                    state.selectedIndex = state.selectedIndex === -1 || state.selectedIndex >= state.pageButtons.length - 1 ? 0 : state.selectedIndex + 1;
                    state.pageButtons[state.selectedIndex].classList.add('selected');
                    state.pageButtons[state.selectedIndex].scrollIntoView({ block: 'nearest' });
                    playBeep();
                    const selectedTitle = state.pageButtons[state.selectedIndex].textContent;
                    const content = storage.getPage(selectedTitle);
                    document.getElementById('title-input').value = selectedTitle;
                    document.getElementById('content-textarea').value = content || '';
                    ui.updateRelatedPagesList();
                    eventHandlers.updateHash(selectedTitle, true);
                } else if (document.activeElement === textareaElement && e.key === 'ArrowUp' && state.listNavigationMode) {
                    e.preventDefault();
                    if (state.pageButtons.length === 0) return;
                    if (state.selectedIndex !== -1) {
                        state.pageButtons[state.selectedIndex].classList.remove('selected');
                    }
                    state.selectedIndex = state.selectedIndex <= 0 ? state.pageButtons.length - 1 : state.selectedIndex - 1;
                    state.pageButtons[state.selectedIndex].classList.add('selected');
                    state.pageButtons[state.selectedIndex].scrollIntoView({ block: 'nearest' });
                    playBeep();
                    const selectedTitle = state.pageButtons[state.selectedIndex].textContent;
                    const content = storage.getPage(selectedTitle);
                    document.getElementById('title-input').value = selectedTitle;
                    document.getElementById('content-textarea').value = content || '';
                    ui.updateRelatedPagesList();
                    eventHandlers.updateHash(selectedTitle, true);
                } else if (document.activeElement === textareaElement && e.key === 'ArrowRight' && isCursorAtEnd(textareaElement)) {
                    e.preventDefault();
                    if (state.relatedPageButtons.length === 0) return;
                    state.relatedListNavigationMode = true;
                    ui.clearPageListHighlight();
                    state.relatedSelectedIndex = 0;
                    state.relatedPageButtons[state.relatedSelectedIndex].classList.add('selected');
                    state.relatedPageButtons[state.relatedSelectedIndex].focus();
                    state.relatedPageButtons[state.relatedSelectedIndex].scrollIntoView({ block: 'nearest' });
                    playBeep();
                    clearTimeout(state.relatedListNavigationTimeout);
                    state.relatedListNavigationTimeout = setTimeout(() => {
                        state.relatedListNavigationMode = false;
                    }, 5000);
                } else if (state.relatedListNavigationMode && e.key === 'ArrowUp') {
                    e.preventDefault();
                    if (state.relatedPageButtons.length === 0) return;
                    if (state.relatedSelectedIndex !== -1) {
                        state.relatedPageButtons[state.relatedSelectedIndex].classList.remove('selected');
                    }
                    state.relatedSelectedIndex = state.relatedSelectedIndex <= 0 ? state.relatedPageButtons.length - 1 : state.relatedSelectedIndex - 1;
                    state.relatedPageButtons[state.relatedSelectedIndex].classList.add('selected');
                    state.relatedPageButtons[state.relatedSelectedIndex].focus();
                    state.relatedPageButtons[state.relatedSelectedIndex].scrollIntoView({ block: 'nearest' });
                    playBeep();
                } else if (state.relatedListNavigationMode && e.key === 'ArrowDown') {
                    e.preventDefault();
                    if (state.relatedPageButtons.length === 0) return;
                    if (state.relatedSelectedIndex !== -1) {
                        state.relatedPageButtons[state.relatedSelectedIndex].classList.remove('selected');
                    }
                    state.relatedSelectedIndex = state.relatedSelectedIndex === -1 || state.relatedSelectedIndex >= state.relatedPageButtons.length - 1 ? 0 : state.relatedSelectedIndex + 1;
                    state.relatedPageButtons[state.relatedSelectedIndex].classList.add('selected');
                    state.relatedPageButtons[state.relatedSelectedIndex].focus();
                    state.relatedPageButtons[state.relatedSelectedIndex].scrollIntoView({ block: 'nearest' });
                    playBeep();
                } else if (state.relatedListNavigationMode && e.key === 'ArrowLeft') {
                    e.preventDefault();
                    if (state.relatedSelectedIndex !== -1) {
                        state.relatedPageButtons[state.relatedSelectedIndex].classList.remove('selected');
                        state.relatedSelectedIndex = -1;
                    }
                    document.getElementById('content-textarea').focus();
                    state.relatedListNavigationMode = false;
                } else if (state.relatedListNavigationMode && e.key === 'Enter') {
                    e.preventDefault();
                    if (state.relatedSelectedIndex !== -1) {
                        const selectedElement = state.relatedPageButtons[state.relatedSelectedIndex];
                        if (selectedElement.tagName === 'A') {
                            window.open(selectedElement.href, '_blank');
                            document.getElementById('content-textarea').focus();
                            playBeep(880, 0.1);
                        } else if (selectedElement.tagName === 'IMG') {
                            window.open(selectedElement.src, '_blank');
                            document.getElementById('content-textarea').focus();
                            playBeep(880, 0.1);
                        } else {
                            const selectedTitle = selectedElement.textContent;
                            const content = storage.getPage(selectedTitle);
                            document.getElementById('title-input').value = selectedTitle;
                            document.getElementById('content-textarea').value = content || '';
                            document.getElementById('content-textarea').focus();
                            playBeep(880, 0.1);
                            eventHandlers.updateHash(selectedTitle, true);
                        }
                        state.relatedListNavigationMode = false;
                    }
                } else if (document.activeElement === inputElement && e.key === 'ArrowRight' && inputElement.selectionStart === inputElement.value.length) {
                    e.preventDefault();
                    if (state.relatedPageButtons.length === 0) return;
                    state.relatedListNavigationMode = true;
                    ui.clearPageListHighlight();
                    state.relatedSelectedIndex = 0;
                    state.relatedPageButtons[state.relatedSelectedIndex].classList.add('selected');
                    state.relatedPageButtons[state.relatedSelectedIndex].focus();
                    state.relatedPageButtons[state.relatedSelectedIndex].scrollIntoView({ block: 'nearest' });
                    playBeep();
                    clearTimeout(state.relatedListNavigationTimeout);
                    state.relatedListNavigationTimeout = setTimeout(() => {
                        state.relatedListNavigationMode = false;
                    }, 5000);
                } else if (state.relatedListNavigationMode && (e.key === 'ArrowUp' || e.key === 'ArrowDown')) {
                    e.preventDefault();
                    if (state.relatedSelectedIndex !== -1) {
                        state.relatedPageButtons[state.relatedSelectedIndex].classList.remove('selected');
                    }
                    if (e.key === 'ArrowUp') {
                        state.relatedSelectedIndex = state.relatedSelectedIndex <= 0 ? state.relatedPageButtons.length - 1 : state.relatedSelectedIndex - 1;
                    } else if (e.key === 'ArrowDown') {
                        state.relatedSelectedIndex = state.relatedSelectedIndex === -1 || state.relatedSelectedIndex >= state.relatedPageButtons.length - 1 ? 0 : state.relatedSelectedIndex + 1;
                    }
                    if (state.relatedSelectedIndex !== -1) {
                        state.relatedPageButtons[state.relatedSelectedIndex].classList.add('selected');
                        state.relatedPageButtons[state.relatedSelectedIndex].focus();
                        state.relatedPageButtons[state.relatedSelectedIndex].scrollIntoView({ block: 'nearest' });
                        playBeep();
                    }
                } else if (document.activeElement === inputElement && e.key === 'Enter' && !state.isIMEComposing) {
                    e.preventDefault();
                    if (state.selectedIndex !== -1) {
                        const selectedTitle = state.pageButtons[state.selectedIndex].textContent;
                        ui.loadPage(selectedTitle);
                    } else {
                        document.getElementById('content-textarea').focus();
                    }
                } else if (document.activeElement === inputElement && (e.key === 'ArrowUp' || e.key === 'ArrowDown')) {
                    e.preventDefault();
                    if (state.pageButtons.length === 0) return;
                    if (state.selectedIndex !== -1) {
                        state.pageButtons[state.selectedIndex].classList.remove('selected');
                    }
                    if (e.key === 'ArrowUp') {
                        state.selectedIndex = state.selectedIndex <= 0 ? state.pageButtons.length - 1 : state.selectedIndex - 1;
                    } else if (e.key === 'ArrowDown') {
                        state.selectedIndex = state.selectedIndex === -1 || state.selectedIndex >= state.pageButtons.length - 1 ? 0 : state.selectedIndex + 1;
                    }
                    if (state.selectedIndex !== -1) {
                        state.pageButtons[state.selectedIndex].classList.add('selected');
                        state.pageButtons[state.selectedIndex].scrollIntoView({ block: 'nearest' });
                        playBeep();
                        const selectedTitle = state.pageButtons[state.selectedIndex].textContent;
                        const content = storage.getPage(selectedTitle);
                        document.getElementById('title-input').value = selectedTitle;
                        document.getElementById('content-textarea').value = content || '';
                        ui.updateRelatedPagesList();
                        eventHandlers.updateHash(selectedTitle, true);
                    }
                } else if (document.activeElement === inputElement && e.key === 'Tab') {
                    e.preventDefault();
                    document.getElementById('content-textarea').focus();
                } else if (document.activeElement === textareaElement && (e.key === 'Tab' || e.key === 'Enter')) {
                    e.preventDefault();
                    document.getElementById('title-input').value = '';
                    document.getElementById('content-textarea').value = '';
                    document.getElementById('title-input').focus();
                    ui.updatePageList('');
                    ui.updateRelatedPagesList();
                }
            },
            onClickPageList: function (title) {
                ui.loadPage(title);
            },
            onHoverPageList: function (title) {
                ui.loadPage(title);
            },
            updateHash: function (title, pushState) {
                const encodedTitle = encodeURIComponent(title);
                if (pushState) {
                    history.pushState({ title }, '', `#${encodedTitle}`);
                } else {
                    history.replaceState({ title }, '', `#${encodedTitle}`);
                }
            }
        };

        // „É¶„Éº„ÉÜ„Ç£„É™„ÉÜ„Ç£Èñ¢Êï∞
        function playBeep(frequency = 440, duration = 0.1) {
            if (!state.audioContext) {
                state.audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
            const oscillator = state.audioContext.createOscillator();
            const gainNode = state.audioContext.createGain();
            oscillator.connect(gainNode);
            gainNode.connect(state.audioContext.destination);
            oscillator.type = 'sine';
            oscillator.frequency.value = frequency;
            gainNode.gain.value = 0.1;
            gainNode.gain.exponentialRampToValueAtTime(0.0001, state.audioContext.currentTime + duration);
            oscillator.start();
            oscillator.stop(state.audioContext.currentTime + duration);
        }

        function isCursorAtEnd(textarea) {
            return textarea.selectionStart === textarea.value.length;
        }

        function getCurrentLine(textarea) {
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const text = textarea.value;
            const beforeCursor = text.substring(0, start);
            const lineBreakPos = beforeCursor.lastIndexOf('\n');
            const lineStart = lineBreakPos === -1 ? 0 : lineBreakPos + 1;
            const lineEnd = text.indexOf('\n', start);
            const line = lineEnd === -1 ? text.substring(lineStart) : text.substring(lineStart, lineEnd);
            return line.trim();
        }

        function exportToJson() {
            const data = {};
            const pages = storage.getAllPages();
            pages.forEach(page => {
                data[page.title] = {
                    content: storage.getPage(page.title),
                    meta: JSON.parse(localStorage.getItem(`wiki_meta_${page.title}`) || '{}')
                };
            });
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'wiki_export.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function importFromJson(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    const data = JSON.parse(e.target.result);
                    for (const title in data) {
                        storage.savePage(title, data[title].content);
                        localStorage.setItem(`wiki_meta_${title}`, JSON.stringify(data[title].meta || { updatedAt: Date.now() }));
                    }
                    alert('„Ç§„É≥„Éù„Éº„Éà„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„Åü„ÄÇ');
                    ui.updatePageList(state.currentFilter);
                    ui.updateRelatedPagesList();
                } catch (error) {
                    alert('„Ç§„É≥„Éù„Éº„Éà„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message);
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        function openModal() {
            document.getElementById('settings-modal').style.display = 'block';
            github.loadSettings();
        }

        function closeModal() {
            document.getElementById('settings-modal').style.display = 'none';
        }

        // „É°„Ç§„É≥ÂàùÊúüÂåñÂá¶ÁêÜ
        function init() {
            storage.cleanEmptyEntries();
            const hash = decodeURIComponent(location.hash.substring(1));

            github.loadSettings();
            if (state.githubSettings.username && state.githubSettings.repo && state.githubSettings.token) {
                document.getElementById('sync-status').textContent = 'ÂêåÊúü‰∏≠...';
                document.getElementById('sync-status').style.display = 'block';
                github.syncFromGithub().then(syncSuccess => {
                    if (!syncSuccess) {
                        document.getElementById('sync-status').textContent = 'ÂêåÊúüÂæÖ„Å°';
                    }
                });
            } else {
                document.getElementById('sync-status').style.display = 'none';
            }

            if (hash) {
                ui.loadPage(hash, false);
            } else {
                const lastOpenedTitle = localStorage.getItem('last_opened_page');
                if (lastOpenedTitle) {
                    ui.loadPage(lastOpenedTitle, false);
                } else {
                    ui.newPage();
                }
            }

            ui.updatePageList();
            ui.updateRelatedPagesList();

            document.getElementById('title-input').addEventListener('input', eventHandlers.onTitleInput);
            document.getElementById('content-textarea').addEventListener('input', eventHandlers.onContentInput);
            document.addEventListener('keydown', eventHandlers.onKeyDown);
            document.getElementById('file-input').addEventListener('change', importFromJson);
            document.getElementById('export-button').addEventListener('click', exportToJson);
            document.getElementById('import-button').addEventListener('click', () => {
                document.getElementById('file-input').click();
            });
            document.getElementById('info-button').addEventListener('click', openModal);
            document.getElementById('modal-close').addEventListener('click', closeModal);
            document.getElementById('save-github-settings').addEventListener('click', github.saveSettings);
            document.getElementById('sync-to-github').addEventListener('click', github.syncToGithub);
            document.getElementById('sync-from-github').addEventListener('click', github.syncFromGithub);
            window.addEventListener('click', function (e) {
                const modal = document.getElementById('settings-modal');
                if (e.target === modal) {
                    closeModal();
                }
            });
            document.addEventListener('click', function (e) {
                if (e.target === document.body || e.target === document.documentElement) {
                    const textarea = document.getElementById('content-textarea');
                    const input = document.getElementById('title-input');
                    if (textarea.value.trim() === '') {
                        input.focus();
                    } else {
                        textarea.focus();
                    }
                }
            });
            window.addEventListener('focus', function () {
                const textarea = document.getElementById('content-textarea');
                const input = document.getElementById('title-input');
                if (textarea.value.trim() === '') {
                    input.focus();
                } else {
                    textarea.focus();
                }
            });
            window.addEventListener('popstate', function (e) {
                const hash = decodeURIComponent(location.hash.substring(1));
                if (hash) {
                    ui.loadPage(hash, false);
                } else {
                    ui.newPage();
                }
            });
            document.addEventListener('touchstart', function () { }, { passive: true });
            document.getElementById('title-input').addEventListener('compositionstart', () => {
                state.isIMEComposing = true;
            });
            document.getElementById('title-input').addEventListener('compositionend', () => {
                state.isIMEComposing = false;
            });
            document.getElementById('title-input').addEventListener('click', function () {
                document.getElementById('title-input').value = '';
                document.getElementById('content-textarea').value = '';
                ui.updatePageList('');
                ui.updateRelatedPagesList();
            });
            document.getElementById('title-input').addEventListener('input', function (e) {
                let value = e.target.value;
                let newValue = value.replace(/ÔºªÔºê-ÔºôÔºΩ/g, function (s) {
                    return String.fromCharCode(s.charCodeAt(0) - 0xFEE0);
                }).replace(/[Ôºê-Ôºô]/g, function (s) {
                    return String.fromCharCode(s.charCodeAt(0) - 0xFEE0);
                });
                if (value !== newValue) {
                    e.target.value = newValue;
                    const event = new Event('input', { bubbles: true });
                    e.target.dispatchEvent(event);
                }
            });
            document.getElementById('title-input').addEventListener('input', function (e) {
                const input = e.target;
                const cursorPos = input.selectionStart;
                const text = input.value;
                const lastChar = text[cursorPos - 1];
                if (lastChar === '„Éª') {
                    if (/^\d/.test(text)) {
                        const newText = text.substring(0, cursorPos - 1) + '/' + text.substring(cursorPos);
                        input.value = newText;
                        input.selectionStart = cursorPos;
                        input.selectionEnd = cursorPos;
                        const event = new Event('input', { bubbles: true });
                        input.dispatchEvent(event);
                    }
                }
            });
        }

        // ÂàùÊúüÂåñ
        init();

</script>
</html>